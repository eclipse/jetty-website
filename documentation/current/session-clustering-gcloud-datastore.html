<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Session Clustering with Google Cloud Datastore</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty : The Definitive Reference"><link rel="up" href="session-management.html" title="Chapter&nbsp;10.&nbsp;Session Management"><link rel="prev" href="session-clustering-infinispan.html" title="Session Clustering with Infinispan"><link rel="next" href="jndi.html" title="Chapter&nbsp;11.&nbsp;Configuring JNDI"><link xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" rel="shortcut icon" href="images/favicon.ico"><script type="text/javascript" src="js/shCore.js"></script><script type="text/javascript" src="js/shBrushJava.js"></script><script type="text/javascript" src="js/shBrushXml.js"></script><script type="text/javascript" src="js/shBrushBash.js"></script><script type="text/javascript" src="js/shBrushJScript.js"></script><script type="text/javascript" src="js/shBrushSql.js"></script><script type="text/javascript" src="js/shBrushProperties.js"></script><script type="text/javascript" src="js/shBrushPlain.js"></script><link type="text/css" rel="stylesheet" href="css/shCore.css"><link type="text/css" rel="stylesheet" href="css/shThemeEclipse.css"><link type="text/css" rel="stylesheet" href="css/font-awesome.min.css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tr><td style="width: 25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty Logo"></a><br><span style="font-size: small">
            Version: 9.3.1-SNAPSHOT</span></td><td style="width: 50%"><script type="text/javascript">  (function() {
            var cx = '016459005284625897022:obd4lsai2ds';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
            })();
          </script><gcse:search></gcse:search></td></tr></table><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Session Clustering with Google Cloud Datastore</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="session-clustering-infinispan.html"><i class="icon-chevron-left"></i> Previous</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;10.&nbsp;Session Management<br><a accesskey="p" href="index.html"><i class="icon-home"></i> Home</a></th><td width="20%" align="right">&nbsp;<a accesskey="n" href="jndi.html">Next <i class="icon-chevron-right"></i></a></td></tr></table><hr></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="jetty-callout"><h5 class="callout"><a href="http://www.webtide.com/">Contact the core Jetty developers at
          <span class="website">www.webtide.com</span></a></h5><p>
 private support for your internal/customer projects ... custom extensions and distributions ... versioned snapshots for indefinite support ...
 scalability guidance for your apps and Ajax/Comet projects ... development services from 1 day to full product delivery
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="session-clustering-gcloud-datastore"></a>Session Clustering with Google Cloud Datastore</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="session-clustering-gcloud-datastore.html#d0e9940">Configuration</a></span></dt><dt><span class="section"><a href="session-clustering-gcloud-datastore.html#d0e9957">The gcloud-sessions Module</a></span></dt></dl></div><p>Jetty can support session clustering by persisting sessions to <a class="link" href="https://cloud.google.com/datastore/docs/concepts/overview" target="_top">Google
  Cloud Datastore</a>. Each Jetty instance locally caches sessions for
  which it has received requests, writing any changes to the session through
  to the Datastore as the request exits the server. Sessions must obey the
  Serialization contract, and servlets must call the Session.setAttribute()
  method to ensure that changes are persisted.</p><p>The persistent session mechanism works in conjunction with a load
  balancer that supports stickiness. Stickiness can be based on various data
  items, such as source IP address or characteristics of the session ID or a
  load-balancer specific mechanism. For those load balancers that examine the
  session ID, the Jetty persistent session mechanism appends a node ID to the
  session ID, which can be used for routing.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9940"></a>Configuration</h3></div></div></div><p>There are two components to session management in Jetty: a session
    ID manager and a session manager.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The session ID manager ensures that session IDs are unique
        across all webapps hosted on a Jetty instance, and thus there can only
        be one session ID manager per Jetty instance.</p></li><li class="listitem"><p>The session manager handles the session lifecycle
        (create/update/invalidate/expire) on behalf of a web application, so
        there is one session manager per web application instance.</p></li></ul></div><p>These managers also cooperate and collaborate with the
    <code class="code">org.eclipse.jetty.server.session.SessionHandler</code> to enable
    cross-context dispatch.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9957"></a>The gcloud-sessions Module</h3></div></div></div><p>When using the jetty distribution, to enable Cloud Datastore session
    persistence, you will first need to enable the
    <code class="code">gcloud-sessions</code> <a class="link" href="startup-modules.html" title="Managing Startup Modules">module</a>
    for your <a class="link" href="quickstart-running-jetty.html#creating-jetty-base" title="Creating a new Jetty Base">base</a> using the
    --add-to-start or --add-to-startd argument to the <a class="link" href="startup.html#startup-overview" title="Startup Overview">start.jar</a>.</p><p>As part of the module installation, the necessary jars will be
    dynamically downloaded and installed to your
    <code class="code">${jetty.base}/lib/gcloud</code> directory. If you need to up or
    downgrade the version of the jars, then you can delete the jars that were
    automatically installed and replace them. Once you've done that, you will
    need to prevent jetty's startup checks from detecting the missing jars. To
    do that, you can use <code class="code">--skip-file-validation=glcoud-sessions</code>
    argument to start.jar on the command line, or place that line inside
    <code class="code">${jetty.base}/start.ini</code> to ensure it is used for every
    start.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9985"></a>Configuring the GCloudSessionIdManager</h4></div></div></div><p>The
      gcloud-sessions module will have installed file called
      <code class="code">${jetty.home}/etc/jetty-gcloud-sessions.xml</code>. This file
      configures an instance of the GCloudSessionIdManager that will be shared
      across all webapps deployed on that server. It looks like this:</p><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[<?xml version="1.0"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_3.dtd">

<Configure id="Server" class="org.eclipse.jetty.server.Server">

  <!-- ============================================================================================== -->
  <!-- GCloud configuration.                                                                          -->
  <!-- Note: passwords can use jetty obfuscation.  See                                                -->
  <!-- https://www.eclipse.org/jetty/documentation/current/configuring-security-secure-passwords.html -->
  <!-- See your start.ini or gcloud-sessions.ini file for more configuration information.             -->
  <!-- ============================================================================================== -->
  <New id="gconf" class="org.eclipse.jetty.gcloud.session.GCloudConfiguration">
    <!-- Either set jetty.gcloudSession.projectId or use system property/env var DATASTORE_DATASET-->
    <Set name="projectId"><Property name="jetty.gcloudSession.projectId"/></Set>
    <!-- To contact remote gclouddatastore set the following properties in start.ini -->
    <Set name="p12File"><Property name="jetty.gcloudSession.p12File"/></Set>
    <Set name="serviceAccount"><Property name="jetty.gcloudSession.serviceAccount"/></Set>
    <Set name="password"><Property name="jetty.gcloudSession.password"/></Set>
  </New>


  <!-- ===================================================================== -->
  <!-- Configure a GCloudSessionIdManager                                    -->
  <!-- ===================================================================== -->
  <Set name="sessionIdManager">
    <New id="idMgr" class="org.eclipse.jetty.gcloud.session.GCloudSessionIdManager">
      <Arg>
        <Ref id="Server"/>
      </Arg>
      <Set name="workerName"><Property name="jetty.gcloudSession.workerName" default="node1"/></Set>
      <Set name="config"><Ref id="gconf"/></Set>
    </New>
  </Set>

</Configure>
]]>
        </script><p>You configure it by setting values for properties. The properties
      will either be inserted as commented out in your <code class="code">start.ini</code>,
      or your <code class="code">start.d/gcloud-sessions.ini</code> file, depending on how
      you enabled the module.</p><p>The only property you always need to set is the name of the node
      in the cluster:</p><div class="variablelist"><dl><dt><span class="term">jetty.gcloudSession.workerName</span></dt><dd><p>The name that uniquely identifies this node in the cluster.
            This value will also be used by the sticky load balancer to
            identify the node. Don't forget to change the value of this
            property on <span class="bold"><strong>each</strong></span> node on which
            you enable gcloud datastore session clustering.</p></dd></dl></div><p>Which other properties you need to set depends on the execution
      environment:</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="d0e10018"></a>Running Within Google Infrastructure</h5></div></div></div><p>When you upload your webapp to run in Compute Engine, you do not
        need to set any other properties for jetty. If you follow the
        instructions in the <a class="link" href="https://cloud.google.com/datastore/docs/activate" target="_top">Cloud
        Datastore documentation</a>, all authorizations etc will be
        provided by the runtime environment.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="d0e10026"></a>Running Externally to Google Infrastructure</h5></div></div></div><p>When your app is executing outside of Google, you can either
        contact a remote Cloud Datastore instance, or a <a class="link" href="https://cloud.google.com/datastore/docs/tools/devserver" target="_top">local
        test dev server</a> provided by the sdk. The choice determines
        which properties you need to set:</p><div class="variablelist"><dl><dt><span class="term">Contacting an sdk dev server for testing:</span></dt><dd><p>In this case, you need to set up either some
              <span class="emphasis"><em>System</em></span> properties or <span class="emphasis"><em>environment
              variables</em></span> - NOT jetty properties!</p><div class="variablelist"><dl><dt><span class="term">DATASTORE_DATASET</span></dt><dd><p>This must be the name of your (test)
                      project.</p></dd><dt><span class="term">DATASTORE_HOST</span></dt><dd><p>This is the url of the dev server as described at
                      <a class="link" href="https://cloud.google.com/datastore/docs/tools/devserver#setting_environment_variables" target="_top">https://cloud.google.com/datastore/docs/tools/devserver#setting_environment_variables</a>.
                      An example may be "http://localhost:9999"</p></dd></dl></div></dd><dt><span class="term">Contacting a remote Cloud Datastore:</span></dt><dd><p>In this case, you need to provide all of the
              authentication and authorization information explicitly via
              jetty properties in the ini file:</p><div class="variablelist"><dl><dt><span class="term">jetty.gcloudSession.projectId</span></dt><dd><p>This is the name of your project.</p></dd><dt><span class="term">jetty.gcloudSession.p12File</span></dt><dd><p>This is the location of the p12 key file that is
                    associated with your project.</p></dd><dt><span class="term">jetty.gcloudSession.serviceAccount</span></dt><dd><p>This is the email address that defines your service
                    account for the Cloud Datastore.</p></dd><dt><span class="term">jetty.gcloudSession.password</span></dt><dd><p>This is the password associated with the p12 key
                    file.</p></dd></dl></div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10095"></a>Configuring the GCloudSessionManager</h4></div></div></div><p>As mentioned elsewhere, there should be one GCloudSessionManager
      per context (ie webapp). It will need to reference the single
      GCloudSessionIdManager from which it derives the Cloud Datastore
      configuration information.</p><p>The way you configure a GCloudSessionManager depends on whether
      you're configuring from a context xml file or a
      <code class="filename">jetty-web.xml</code> file or code. The basic difference is
      how you get a reference to the Jetty
      <code class="code">org.eclipse.jetty.server.Server</code> instance.</p><p>From a context xml file, you reference the Server instance as a
      Ref:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[  
  
  <!-- Get a reference to the GCloudSessionIdManager -->
  <Ref id="Server">
    <Call id="idMgr" name="getSessionIdManager"/>
  </Ref>

  <!-- Use the GCloudSessionIdManager to set up the GCloudSessionManager -->
  <Set name="sessionHandler">
    <New class="org.eclipse.jetty.server.session.SessionHandler">
      <Arg>
        <New id="mgr" class="org.eclipse.jetty.gcloud.session.GCloudSessionManager">
          <Set name="sessionIdManager">
            <Ref id="idMgr"/>
          </Set>
          <Set name="scavengeIntervalSec">600</Set>
        </New>
      </Arg>
    </New>
  </Set>

]]>
        </script></div><p>From a <code class="filename">WEB-INF/jetty-web.xml</code> file, you can
      reference the Server instance directly:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[  
<!-- Reference the server directly -->
<Get name="server">
  <Get id="idMgr" name="sessionIdManager"/>
</Get>

<!-- Apply the SessionIdManager to the GCloudSessionManager -->
<Set name="sessionHandler">
  <New class="org.eclipse.jetty.server.session.SessionHandler">
     <Arg>
        <New id="mgr" class="org.eclipse.jetty.gcloud.session.GCloudSessionManager">
          <Set name="sessionIdManager">
            <Ref id="idMgr"/>
          </Set>
          <Set name="scavengeIntervalSec">600</Set>
        </New>
      </Arg>
  </New>
</Set>

]]>
        </script></div><p>The GCloudSessionManager supports the following configuration
      setters:</p><div class="variablelist"><dl><dt><span class="term">scavengeIntervalSec</span></dt><dd><p>Time in seconds between runs of a scavenger task that looks
            for expired old sessions to delete. The default is 10 minutes. If
            set to 0, no scavenging is done.</p></dd><dt><span class="term">staleIntervalSec</span></dt><dd><p>The length of time a session can be in memory without being
            checked against the cluster. A value of 0 indicates that the
            session is never checked against the cluster - the current node is
            considered to be the master for the session.</p></dd><dt><span class="term">maxQueryResults</span></dt><dd><p>The maximum number of results to return for a query to find
            expired sessions. For efficiency it is important to limit the size
            of the result. The default is 100. If 0 or negative numbers are
            set, the default is used instead. </p></dd></dl></div></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="session-clustering-infinispan.html"><i class="icon-chevron-left"></i> Previous</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="session-management.html"><i class="icon-chevron-up"></i> Top</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="jndi.html">Next <i class="icon-chevron-right"></i></a></td></tr><tr><td width="40%" align="left" valign="top">Session Clustering with Infinispan&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><i class="icon-home"></i> Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;11.&nbsp;Configuring JNDI</td></tr></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><div class="jetty-callout">
            See an error or something missing?
            <span class="callout"><a href="http://github.com/jetty-project/jetty-documentation">Contribute to this documentation at
                <span class="website"><i class="icon-github"></i> Github!</span></a></span><span style="float: right"><i>(Generated: 2015-12-20T01:01:16+00:00)</i></span></div></p><script xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1149868-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
    </script></body></html>