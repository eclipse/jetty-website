<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Session Clustering with Google Cloud Datastore</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty"><link rel="up" href="session-management.html" title="Chapter&nbsp;10.&nbsp;Session Management"><link rel="prev" href="session-clustering-infinispan.html" title="Session Clustering with Infinispan"><link rel="next" href="jndi.html" title="Chapter&nbsp;11.&nbsp;Configuring JNDI"><link xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" rel="shortcut icon" href="images/favicon.ico"><link rel="stylesheet" href="css/highlighter/foundation.css"><script src="js/highlight.pack.js"></script><script>
      hljs.initHighlightingOnLoad();
    </script><link type="text/css" rel="stylesheet" href="css/font-awesome/font-awesome.min.css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tr><td style="width: 25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty Logo"></a><br><span style="font-size: small">
            Version: 9.4.0-SNAPSHOT</span></td><td style="width: 50%"><script type="text/javascript">  (function() {
            var cx = '016459005284625897022:obd4lsai2ds';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
            })();
          </script><gcse:search></gcse:search></td></tr></table><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Session Clustering with Google Cloud Datastore</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="session-clustering-infinispan.html"><i class="fa fa-chevron-left" aria-hidden="true"></i> Previous</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;10.&nbsp;Session Management<br><a accesskey="p" href="index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a></th><td width="20%" align="right">&nbsp;<a accesskey="n" href="jndi.html">Next <i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr></table><hr></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="jetty-callout"><h5 class="callout"><a href="http://www.webtide.com/">Contact the core Jetty developers at
          <span class="website">www.webtide.com</span></a></h5><p>
 private support for your internal/customer projects ... custom extensions and distributions ... versioned snapshots for indefinite support ...
 scalability guidance for your apps and Ajax/Comet projects ... development services for sponsored feature development
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="session-clustering-gcloud-datastore"></a>Session Clustering with Google Cloud Datastore</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="session-clustering-gcloud-datastore.html#_configuration_4">Configuration</a></span></dt><dt><span class="section"><a href="session-clustering-gcloud-datastore.html#_the_gcloud_sessions_module">The gcloud-sessions Module</a></span></dt></dl></div><p>Jetty can support session clustering by persisting sessions to
<a class="link" href="https://cloud.google.com/datastore/docs/concepts/overview" target="_top">Google Cloud
Datastore</a>. Each Jetty instance locally caches sessions for which it has
received requests, writing any changes to the session through to the
Datastore as the request exits the server. Sessions must obey the
Serialization contract, and servlets must call the
Session.setAttribute() method to ensure that changes are persisted.</p><p>The persistent session mechanism works in conjunction with a load
balancer that supports stickiness. Stickiness can be based on various
data items, such as source IP address or characteristics of the session
ID or a load-balancer specific mechanism. For those load balancers that
examine the session ID, the Jetty persistent session mechanism appends a
node ID to the session ID, which can be used for routing.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration_4"></a>Configuration</h3></div></div></div><p>There are two components to session management in Jetty: a session ID
manager and a session manager.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The session ID manager ensures that session IDs are unique across all
webapps hosted on a Jetty instance, and thus there can only be one
session ID manager per Jetty instance.</li><li class="listitem">The session manager handles the session lifecycle
(create/update/invalidate/expire) on behalf of a web application, so
there is one session manager per web application instance.</li></ul></div><p>These managers also cooperate and collaborate with the
<code class="literal">org.eclipse.jetty.server.session.SessionHandler</code> to enable
cross-context dispatch.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_the_gcloud_sessions_module"></a>The gcloud-sessions Module</h3></div></div></div><p>When using the jetty distribution, to enable Cloud Datastore session
persistence, you will first need to enable the <code class="literal">gcloud-sessions</code>
<a class="link" href="startup-modules.html" title="Managing Startup Modules">module</a> for your <a class="link" href="quickstart-running-jetty.html#creating-jetty-base" title="Creating a new Jetty Base">base</a>
using the --add-to-start or --add-to-startd argument to the
<a class="link" href="startup.html#startup-overview" title="Startup Overview">start.jar</a>.</p><p>As part of the module installation, the necessary jars will be
dynamically downloaded and installed to your <code class="literal">${jetty.base}/lib/gcloud</code>
directory. If you need to up or downgrade the version of the jars, then
you can delete the jars that were automatically installed and replace
them. Once you&#8217;ve done that, you will need to prevent jetty&#8217;s startup
checks from detecting the missing jars. To do that, you can use
<code class="literal">--skip-file-validation=glcoud-sessions</code> argument to start.jar on the
command line, or place that line inside <code class="literal">${jetty.base}/start.ini</code> to
ensure it is used for every start.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_the_gcloudsessionidmanager"></a>Configuring the GCloudSessionIdManager</h4></div></div></div><p>The gcloud-sessions module will have installed file called
<code class="literal">${jetty.home}/etc/jetty-gcloud-sessions.xml</code>. This file configures an
instance of the GCloudSessionIdManager that will be shared across all
webapps deployed on that server. It looks like this:</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>Unresolved directive in administration/sessions/session-clustering-gcloud-datastore.adoc - include::/home/jenkins/.jenkins/workspace/jetty-9.4.x-nightly/jetty-documentation/../jetty-gcloud/jetty-gcloud-session-manager/src/main/config/etc/jetty-gcloud-session-store.xml[]</code></pre><p>You configure it by setting values for properties. The properties will
either be inserted as commented out in your <code class="literal">start.ini</code>, or your
<code class="literal">start.d/gcloud-sessions.ini</code> file, depending on how you enabled the
module.</p><p>The only property you always need to set is the name of the node in the
cluster:</p><div class="variablelist"><dl><dt><span class="term">jetty.gcloudSession.workerName</span></dt><dd>The name that uniquely identifies this node in the cluster. This value
will also be used by the sticky load balancer to identify the node.
Don&#8217;t forget to change the value of this property on <span class="strong"><strong>each</strong></span> node on
which you enable gcloud datastore session clustering.</dd></dl></div><p>Which other properties you need to set depends on the execution
environment:</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_running_within_google_infrastructure"></a>Running Within Google Infrastructure</h5></div></div></div><p>When you upload your webapp to run in Compute Engine, you do not need to
set any other properties for jetty. If you follow the instructions in
the <a class="link" href="https://cloud.google.com/datastore/docs/activate" target="_top">Cloud Datastore
documentation</a>, all authorizations etc will be provided by the runtime
environment.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_running_externally_to_google_infrastructure"></a>Running Externally to Google Infrastructure</h5></div></div></div><p>When your app is executing outside of Google, you can either contact a
remote Cloud Datastore instance, or a
<a class="link" href="https://cloud.google.com/datastore/docs/tools/devserver" target="_top">local test dev
server</a> provided by the sdk. The choice determines which properties you
need to set:</p><div class="variablelist"><dl><dt><span class="term">Contacting an sdk dev server for testing</span></dt><dd><p class="simpara">In this case, you need to set up either some <span class="emphasis"><em>System</em></span> properties or
<span class="emphasis"><em>environment variables</em></span> - NOT jetty properties!
+</p><div class="variablelist"><dl><dt><span class="term">DATASTORE_DATASET</span></dt><dd>This must be the name of your (test) project.</dd><dt><span class="term">DATASTORE_HOST</span></dt><dd>This is the url of the dev server as described at
<a class="link" href="https://cloud.google.com/datastore/docs/tools/devserver#setting_environment_variables" target="_top">https://cloud.google.com/datastore/docs/tools/devserver#setting_environment_variables</a>.
An example may be "http://localhost:9999"</dd></dl></div></dd><dt><span class="term">Contacting a remote Cloud Datastore</span></dt><dd><p class="simpara">In this case, you need to provide all of the authentication and
authorization information explicitly via jetty properties in the ini
file:
+</p><div class="variablelist"><dl><dt><span class="term">jetty.gcloudSession.projectId</span></dt><dd>This is the name of your project.</dd><dt><span class="term">jetty.gcloudSession.p12File</span></dt><dd>This is the location of the p12 key file that is associated with
your project.</dd><dt><span class="term">jetty.gcloudSession.serviceAccount</span></dt><dd>This is the email address that defines your service account for the
Cloud Datastore.</dd><dt><span class="term">jetty.gcloudSession.password</span></dt><dd>This is the password associated with the p12 key file.</dd></dl></div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_the_gcloudsessionmanager"></a>Configuring the GCloudSessionManager</h4></div></div></div><p>As mentioned elsewhere, there should be one GCloudSessionManager per
context (ie webapp). It will need to reference the single
GCloudSessionIdManager from which it derives the Cloud Datastore
configuration information.</p><p>The way you configure a GCloudSessionManager depends on whether you&#8217;re
configuring from a context xml file or a <code class="literal">jetty-web.xml</code> file or code.
The basic difference is how you get a reference to the Jetty
<code class="literal">org.eclipse.jetty.server.Server</code> instance.</p><p>From a context xml file, you reference the Server instance as a Ref:</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>  &lt;!-- Get a reference to the GCloudSessionIdManager --&gt;
  &lt;Ref id="Server"&gt;
    &lt;Call id="idMgr" name="getSessionIdManager"/&gt;
  &lt;/Ref&gt;

  &lt;!-- Use the GCloudSessionIdManager to set up the GCloudSessionManager --&gt;
  &lt;Set name="sessionHandler"&gt;
    &lt;New class="org.eclipse.jetty.server.session.SessionHandler"&gt;
      &lt;Arg&gt;
        &lt;New id="mgr" class="org.eclipse.jetty.gcloud.session.GCloudSessionManager"&gt;
          &lt;Set name="sessionIdManager"&gt;
            &lt;Ref id="idMgr"/&gt;
          &lt;/Set&gt;
          &lt;Set name="scavengeIntervalSec"&gt;600&lt;/Set&gt;
        &lt;/New&gt;
      &lt;/Arg&gt;
    &lt;/New&gt;
  &lt;/Set&gt;</code></pre><p>From a <code class="literal">WEB-INF/jetty-web.xml</code> file, you can reference the Server
instance directly:</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>&lt;!-- Reference the server directly --&gt;
&lt;Get name="server"&gt;
  &lt;Get id="idMgr" name="sessionIdManager"/&gt;
&lt;/Get&gt;

&lt;!-- Apply the SessionIdManager to the GCloudSessionManager --&gt;
&lt;Set name="sessionHandler"&gt;
  &lt;New class="org.eclipse.jetty.server.session.SessionHandler"&gt;
     &lt;Arg&gt;
        &lt;New id="mgr" class="org.eclipse.jetty.gcloud.session.GCloudSessionManager"&gt;
          &lt;Set name="sessionIdManager"&gt;
            &lt;Ref id="idMgr"/&gt;
          &lt;/Set&gt;
          &lt;Set name="scavengeIntervalSec"&gt;600&lt;/Set&gt;
        &lt;/New&gt;
      &lt;/Arg&gt;
  &lt;/New&gt;
&lt;/Set&gt;</code></pre><p>The GCloudSessionManager supports the following configuration setters:</p><div class="variablelist"><dl><dt><span class="term">scavengeIntervalSec</span></dt><dd>Time in seconds between runs of a scavenger task that looks for
expired old sessions to delete. The default is 10 minutes. If set to
0, no scavenging is done.</dd><dt><span class="term">staleIntervalSec</span></dt><dd>The length of time a session can be in memory without being checked
against the cluster. A value of 0 indicates that the session is never
checked against the cluster - the current node is considered to be the
master for the session.</dd><dt><span class="term">maxQueryResults</span></dt><dd>The maximum number of results to return for a query to find expired
sessions. For efficiency it is important to limit the size of the
result. The default is 100. If 0 or negative numbers are set, the
default is used instead.</dd></dl></div></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="session-clustering-infinispan.html"><i class="fa fa-chevron-left" aria-hidden="true"></i> Previous</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="session-management.html"><i class="fa fa-chevron-up" aria-hidden="true"></i> Top</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="jndi.html">Next <i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr><tr><td width="40%" align="left" valign="top">Session Clustering with Infinispan&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;11.&nbsp;Configuring JNDI</td></tr></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><div class="jetty-callout">
            See an error or something missing?
            <span class="callout"><a href="http://github.com/eclipse/jetty.project">Contribute to this documentation at
                <span class="website"><i class="fa fa-github" aria-hidden="true"></i> Github!</span></a></span><span style="float: right"><i>(Generated: 2016-06-04)</i></span></div></p><script xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1149868-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
    </script></body></html>